
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Funky Attendance Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --slate-900: #0f172a;
      --slate-800: #1e293b;
      --slate-700: #334155;
      --slate-600: #475569;
      --slate-400: #94a3b8;
      --slate-300: #cbd5e1;
      --slate-50: #f8fafc;
      --cyan-500: #06b6d4;
      --cyan-400: #22d3ee;
      --fuchsia-500: #d946ef;
      --pink-500: #ec4899;
      --amber-400: #fbbf24;
      --amber-500: #f59e0b;
      --green-500: #22c55e;
      --red-500: #ef4444;
      --yellow-500: #eab308;
    }

    /* --- Base & Animations --- */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes pulse {
      50% { opacity: .5; }
    }
    
    @keyframes slideIn {
        from { transform: translateX(var(--slide-from, 30px)); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--slate-900);
      color: var(--slate-50);
      background-image: radial-gradient(circle at 1px 1px, var(--slate-700) 1px, transparent 0);
      background-size: 2rem 2rem;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    button, input {
      font-family: inherit;
      color: inherit;
    }
    
    .hidden {
      display: none !important;
    }
    
    .glass-pane {
        background-color: rgba(30, 41, 59, 0.5); /* slate-800/50 */
        border: 1px solid var(--slate-700);
        backdrop-filter: blur(12px);
        border-radius: 1rem; /* rounded-2xl */
        box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }
    
    .text-gradient {
        background-image: linear-gradient(to right, var(--amber-400), var(--pink-500));
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
    }
    
    .button-gradient {
        background-image: linear-gradient(to right, var(--fuchsia-500), var(--cyan-500));
    }
    
    .button-gradient-alt {
        background-image: linear-gradient(to right, var(--pink-500), var(--amber-500));
    }

    /* --- Main App Wrapper --- */
    .app-container {
      min-height: 100vh;
      animation: fadeIn 0.5s ease-out forwards;
    }

    /* --- Login Page --- */
    #login-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    
    #login-page .login-form-container {
        width: 100%;
        max-width: 28rem;
        padding: 2rem;
        animation: scaleIn 0.5s ease-out forwards;
    }
    
    #login-page h1 {
        font-size: 2.5rem;
        font-weight: 800;
        letter-spacing: -0.05em;
        margin-bottom: 0.5rem;
    }
    
    #login-page h1 span {
        background-image: linear-gradient(to right, var(--fuchsia-500), var(--cyan-500));
        background-clip: text;
        -webkit-background-clip: text;
        color: transparent;
    }
    
    #login-page p {
        color: var(--slate-400);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    #login-page input {
        width: 100%;
        background-color: var(--slate-700);
        border: 2px solid var(--slate-600);
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        transition: all 0.2s;
    }
    
    #login-page input:focus {
        outline: none;
        box-shadow: 0 0 0 2px var(--cyan-500);
        border-color: var(--cyan-500);
    }
    
    #login-page button {
        width: 100%;
        color: white;
        font-weight: 700;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        transition: opacity 0.2s, transform 0.1s;
    }
    #login-page button:hover {
        opacity: 0.9;
    }
    #login-page button:active {
        transform: scale(0.98);
    }
    #login-page button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* --- Tracker App --- */
    #tracker-app {
      padding: 1rem;
    }
    @media (min-width: 640px) { #tracker-app { padding: 1.5rem; } }
    @media (min-width: 1024px) { #tracker-app { padding: 2rem; } }
    
    #tracker-app-inner {
      max-width: 80rem;
      margin: auto;
    }
    
    #tracker-app header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    @media (min-width: 768px) { #tracker-app header { margin-bottom: 3rem; } }
    
    #tracker-app header h1 {
      font-size: 1.5rem;
      font-weight: 700;
    }
     @media (min-width: 640px) { #tracker-app header h1 { font-size: 1.875rem; } }
    
    #tracker-app header p {
        color: var(--slate-400);
        font-size: 0.875rem;
    }
    
    #logout-button {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background-color: rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border: 1px solid var(--slate-600);
      color: var(--slate-300);
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.1s;
    }
    #logout-button:hover {
        background-color: var(--slate-700);
        transform: scale(1.05);
    }
    #logout-button:active {
        transform: scale(0.95);
    }

    #tracker-app main {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    @media (min-width: 1024px) { #tracker-app main { grid-template-columns: repeat(3, 1fr); } }
    
    .main-col-1 {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }
     @media (min-width: 1024px) { .main-col-1 { grid-column: span 1 / span 1; } }

    .main-col-2 {
      @media (min-width: 1024px) { grid-column: span 2 / span 2; }
    }
    
    .subject-manager, .attendance-summary, .calendar-view {
        padding: 1.5rem;
    }
    
    .component-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1rem;
    }
    
    /* Subject Manager */
    #add-subject-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    #new-subject-input {
        flex-grow: 1;
        background-color: var(--slate-700);
        border: 2px solid var(--slate-600);
        border-radius: 0.5rem;
        padding: 0.5rem 1rem;
    }
     #new-subject-input:focus {
        outline: none;
        box-shadow: 0 0 0 2px var(--cyan-500);
        border-color: var(--cyan-500);
    }
    
    #add-subject-button {
        background-color: var(--cyan-500);
        color: white;
        font-weight: 700;
        padding: 0.75rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
    }
    #add-subject-button:hover {
        background-color: var(--cyan-400);
        transform: scale(1.05);
    }
    #add-subject-button:active {
        transform: scale(0.95);
    }
    
    #subject-list {
        max-height: 12rem;
        overflow-y: auto;
        padding-right: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .subject-item {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s;
        overflow: hidden;
    }
    
    .subject-item.selected .subject-selected-bg {
        position: absolute;
        inset: 0;
        background-color: rgba(217, 70, 239, 0.8);
        border-radius: 0.5rem;
        animation: scaleIn 0.3s ease;
    }
    
    .subject-item .subject-name, .subject-item .delete-subject-button {
        position: relative;
        z-index: 10;
    }
    
    .delete-subject-button {
        color: var(--slate-400);
        background: none;
        border: none;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 9999px;
        transition: color 0.2s, transform 0.1s;
    }
    .delete-subject-button:hover {
        color: var(--red-500);
        transform: scale(1.1);
    }
    
    /* Calendar View */
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    .calendar-header h3 {
        font-size: 1.25rem;
        font-weight: 700;
        text-align: center;
        width: 100%;
    }
    .calendar-nav-button {
        padding: 0.5rem;
        border-radius: 9999px;
        background: none;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
    }
    .calendar-nav-button:hover {
        background-color: var(--slate-700);
        transform: scale(1.1);
    }
    .calendar-nav-button:active {
        transform: scale(0.9);
    }
    
    .calendar-weekdays, #calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0.5rem;
        text-align: center;
    }
    
    .calendar-weekdays {
        margin-bottom: 0.5rem;
        font-size: 0.75rem;
        font-weight: 700;
        color: var(--slate-400);
        text-transform: uppercase;
    }
    
    #calendar-grid-container {
        overflow: hidden;
        position: relative;
    }
    
    .calendar-day {
        position: relative;
        aspect-ratio: 1 / 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 9999px;
        font-weight: 600;
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        background-color: var(--slate-700);
    }
    
    .calendar-day.not-allowed { cursor: not-allowed; }
    .calendar-day:not(.not-allowed):hover { background-color: var(--slate-600); }
    .calendar-day.empty { background-color: transparent; cursor: default; }

    .calendar-day.today {
        outline: 2px solid var(--cyan-400);
    }

    .calendar-day.present { background-color: rgba(34, 197, 94, 0.8); color: white; box-shadow: 0 0 15px 0 rgba(34, 197, 94, 0.3); }
    .calendar-day.absent { background-color: rgba(239, 68, 68, 0.8); color: white; box-shadow: 0 0 15px 0 rgba(239, 68, 68, 0.3); }
    .calendar-day.holiday { background-color: rgba(234, 179, 8, 0.8); color: white; box-shadow: 0 0 15px 0 rgba(234, 179, 8, 0.3); }
    
    .calendar-legend {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 1rem 1rem;
        margin-top: 1.5rem;
        font-size: 0.75rem;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .legend-color {
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 9999px;
    }

    /* Attendance Summary */
    .summary-stats {
        display: flex;
        justify-content: space-around;
        text-align: center;
    }
    .summary-stats .stat-value {
        font-size: 1.875rem;
        font-weight: 700;
    }
    .summary-stats .stat-label {
        font-size: 0.75rem;
        color: var(--slate-400);
        text-transform: uppercase;
    }
    
    .progress-bar-container {
        width: 100%;
        background-color: var(--slate-700);
        border-radius: 9999px;
        height: 1rem;
        overflow: hidden;
    }
    #progress-bar {
        height: 100%;
        transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
    }
    
    #summary-message-box {
        background-color: rgba(15, 23, 42, 0.5); /* slate-900/50 */
        border-radius: 0.5rem;
        padding: 0.75rem;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
    
    #excuse-button {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        color: white;
        font-weight: 700;
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    #excuse-button:hover {
        opacity: 0.9;
        transform: scale(1.02);
    }
     #excuse-button:active {
        transform: scale(0.98);
    }
     #excuse-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    #excuse-result {
        margin-top: 1rem;
        padding: 0.75rem;
        background-color: var(--slate-700);
        border: 1px solid var(--slate-600);
        border-radius: 0.5rem;
        font-size: 0.875rem;
        text-align: center;
        font-style: italic;
    }
  </style>
</head>
<body class="antialiased">
  
  <div id="app-root"></div>
  
  <template id="login-template">
    <div id="login-page" class="app-container">
      <div class="login-form-container glass-pane">
        <div style="text-align: center; margin-bottom: 2rem;">
          <h1 ><span>Welcome Back!</span></h1>
          <p>Let's get this party started 
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.25rem; height: 1.25rem; color: var(--amber-400);">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.5 21.75l-.398-1.188a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.188-.398a2.25 2.25 0 001.423-1.423L16.5 15.75l.398 1.188a2.25 2.25 0 001.423 1.423l1.188.398-1.188.398a2.25 2.25 0 00-1.423 1.423z"/>
            </svg>
          </p>
        </div>
        <form id="login-form" style="display: flex; flex-direction: column; gap: 1.5rem;">
            <div>
              <label for="username-input" style="font-size: 0.875rem; font-weight: 700; color: var(--slate-300); display: block; margin-bottom: 0.5rem;">
                What should we call you?
              </label>
              <input id="username-input" type="text" placeholder="Enter your funky name" required />
            </div>
            <button id="login-button" type="submit" class="button-gradient" disabled>
              Let's Go!
            </button>
        </form>
      </div>
    </div>
  </template>

  <template id="tracker-template">
    <div id="tracker-app" class="app-container">
      <div id="tracker-app-inner">
        <header>
           <div>
            <h1 id="welcome-message"></h1>
            <p>Ready to track your triumphs?</p>
          </div>
          <button id="logout-button">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.25rem; height: 1.25rem;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m-3-3l3-3m0 0l-3-3m3 3H9"/>
            </svg>
            <span>Logout</span>
          </button>
        </header>

        <main>
          <div class="main-col-1">
            <div class="subject-manager glass-pane">
              <h2 class="component-title text-gradient">1. Your Subjects</h2>
              <div id="add-subject-group">
                <input type="text" id="new-subject-input" placeholder="e.g., Quantum Fizz-ics" />
                <button id="add-subject-button">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.25rem; height: 1.25rem;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                  </svg>
                </button>
              </div>
              <div id="subject-list">
                <p style="text-align: center; color: var(--slate-400); padding: 1rem 0;">Add a subject to get started!</p>
              </div>
            </div>
            <div id="attendance-summary-wrapper" class="attendance-summary glass-pane">
              <!-- Summary content will be injected here -->
            </div>
          </div>

          <div class="main-col-2">
            <div class="calendar-view glass-pane">
              <h2 class="component-title text-gradient" style="text-align: center;">2. Log Your Days</h2>
              <div class="calendar-header">
                <button id="prev-month-button" class="calendar-nav-button">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.5rem; height: 1.5rem;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                  </svg>
                </button>
                <h3 id="month-year-display"></h3>
                <button id="next-month-button" class="calendar-nav-button">
                   <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.5rem; height: 1.5rem;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                  </svg>
                </button>
              </div>
              <div class="calendar-weekdays">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
              </div>
              <div id="calendar-grid-container">
                <div id="calendar-grid"></div>
              </div>
              <div class="calendar-legend">
                  <div class="legend-item"><div class="legend-color" style="background-color: var(--green-500);"></div><span>Present</span></div>
                  <div class="legend-item"><div class="legend-color" style="background-color: var(--red-500);"></div><span>Absent</span></div>
                  <div class="legend-item"><div class="legend-color" style="background-color: var(--yellow-500);"></div><span>Holiday</span></div>
                  <div class="legend-item"><div class="legend-color" style="background-color: var(--slate-700);"></div><span>Unmarked</span></div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </template>

  <script type="module">
    import { GoogleGenAI } from "https://esm.run/@google/genai";

    // --- STATE & CONSTANTS ---
    const APP_STATE = {
      currentUser: null,
      subjects: [],
      attendanceLog: {},
      selectedSubject: null,
      currentDate: new Date(),
    };
    const DOM = {};
    const STORAGE_KEY_USER = 'funky-attendance-user';
    const TARGET_ATTENDANCE_PERCENTAGE = 75;

    // --- GEMINI SERVICE ---
    const API_KEY = process.env.API_KEY;
    let ai;
    if (API_KEY) {
      ai = new GoogleGenAI({ apiKey: API_KEY });
    } else {
      console.error("API_KEY environment variable not set. AI features will be disabled.");
    }

    async function generateExcuse(subjectName) {
      if (!ai) {
        return "AI is sleeping... Looks like the API key is missing.";
      }
      try {
        const prompt = `Generate a short, creative, and extremely funny excuse for missing a class called "${subjectName}". Make it sound slightly unbelievable but humorous. Keep it to one or two sentences.`;
        const response = await ai.models.generateContent({
            model: 'gemini-2.5-flash',
            contents: prompt,
            config: { temperature: 1, topP: 0.95 }
        });
        return response.text;
      } catch (error) {
        console.error("Error generating excuse with Gemini API:", error);
        return "My creative circuits are fried! I couldn't think of an excuse. Try again?";
      }
    }

    // --- LOCAL STORAGE UTILS ---
    function loadFromStorage(key, defaultValue) {
      try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultValue;
      } catch (e) {
        console.error(`Error loading from localStorage key "${key}"`, e);
        return defaultValue;
      }
    }

    function saveToStorage(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.error(`Error saving to localStorage key "${key}"`, e);
      }
    }
    
    // --- RENDER FUNCTIONS ---
    function renderApp() {
      const appRoot = document.getElementById('app-root');
      appRoot.innerHTML = ''; // Clear previous content
      
      if (APP_STATE.currentUser) {
        const trackerTemplate = document.getElementById('tracker-template').content.cloneNode(true);
        appRoot.appendChild(trackerTemplate);
        
        // Cache DOM elements for the tracker
        DOM.welcomeMessage = document.getElementById('welcome-message');
        DOM.logoutButton = document.getElementById('logout-button');
        DOM.subjectList = document.getElementById('subject-list');
        DOM.newSubjectInput = document.getElementById('new-subject-input');
        DOM.addSubjectButton = document.getElementById('add-subject-button');
        DOM.monthYearDisplay = document.getElementById('month-year-display');
        DOM.calendarGrid = document.getElementById('calendar-grid');
        DOM.calendarGridContainer = document.getElementById('calendar-grid-container');
        DOM.prevMonthButton = document.getElementById('prev-month-button');
        DOM.nextMonthButton = document.getElementById('next-month-button');
        DOM.summaryWrapper = document.getElementById('attendance-summary-wrapper');
        
        // Setup Tracker
        DOM.welcomeMessage.innerHTML = `Hey, <span class="text-gradient">${APP_STATE.currentUser}!</span>`;
        addTrackerEventListeners();
        renderSubjectList();
        renderCalendar();
        renderSummary();
      } else {
        const loginTemplate = document.getElementById('login-template').content.cloneNode(true);
        appRoot.appendChild(loginTemplate);
        
        // Cache DOM elements for login
        DOM.loginForm = document.getElementById('login-form');
        DOM.usernameInput = document.getElementById('username-input');
        DOM.loginButton = document.getElementById('login-button');
        
        addLoginEventListeners();
      }
    }

    function renderSubjectList() {
      DOM.subjectList.innerHTML = '';
      if (APP_STATE.subjects.length === 0) {
        DOM.subjectList.innerHTML = `<p style="text-align: center; color: var(--slate-400); padding: 1rem 0;">Add a subject to get started!</p>`;
        return;
      }
      APP_STATE.subjects.forEach(subject => {
        const item = document.createElement('div');
        item.className = 'subject-item';
        item.dataset.subject = subject;
        if (subject === APP_STATE.selectedSubject) {
          item.classList.add('selected');
        }
        item.innerHTML = `
          <div class="subject-selected-bg"></div>
          <span class="subject-name">${subject}</span>
          <button class="delete-subject-button" data-subject="${subject}">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 1.25rem; height: 1.25rem; pointer-events: none;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.124-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.077-2.09.921-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/>
            </svg>
          </button>
        `;
        item.addEventListener('click', () => handleSelectSubject(subject));
        item.querySelector('.delete-subject-button').addEventListener('click', (e) => {
          e.stopPropagation();
          handleDeleteSubject(subject);
        });
        DOM.subjectList.appendChild(item);
      });
    }
    
    function renderCalendar(direction = 0) {
        const { year, month } = { year: APP_STATE.currentDate.getFullYear(), month: APP_STATE.currentDate.getMonth() };
        DOM.monthYearDisplay.textContent = `${APP_STATE.currentDate.toLocaleString('default', { month: 'long' })} ${year}`;

        const gridHtml = generateCalendarGrid(year, month);
        
        if (direction !== 0) {
            const oldGrid = DOM.calendarGrid;
            const newGrid = oldGrid.cloneNode(true);
            newGrid.innerHTML = gridHtml;
            
            DOM.calendarGridContainer.style.setProperty('--slide-from', direction > 0 ? '30px' : '-30px');
            newGrid.style.animation = 'slideIn 0.3s ease-out forwards';
            
            oldGrid.style.animation = 'slideIn 0.3s ease-out reverse forwards';
            oldGrid.addEventListener('animationend', () => oldGrid.remove(), { once: true });
            
            DOM.calendarGridContainer.appendChild(newGrid);
            DOM.calendarGrid = newGrid;
        } else {
             DOM.calendarGrid.innerHTML = gridHtml;
        }
        
        // Add event listeners after rendering
        DOM.calendarGrid.querySelectorAll('.calendar-day:not(.empty)').forEach(cell => {
           cell.addEventListener('click', () => handleDayClick(parseInt(cell.dataset.day)));
        });
    }

    function generateCalendarGrid(year, month) {
        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let gridHtml = '';
        for (let i = 0; i < firstDayOfMonth; i++) {
          gridHtml += `<div class="calendar-day empty"></div>`;
        }
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          date.setHours(0,0,0,0);
          const dateString = new Date(Date.UTC(year, month, day)).toISOString().split('T')[0];
          const status = APP_STATE.selectedSubject ? APP_STATE.attendanceLog[APP_STATE.selectedSubject]?.[dateString] : null;

          let classes = 'calendar-day';
          if (!APP_STATE.selectedSubject) classes += ' not-allowed';
          if (date.getTime() === today.getTime()) classes += ' today';
          if (status) classes += ` ${status}`;
          
          gridHtml += `<div class="${classes}" data-day="${day}">${day}</div>`;
        }
        return gridHtml;
    }

    function renderSummary() {
      const { selectedSubject, attendanceLog, currentDate } = APP_STATE;
      
      let conducted = 0, attended = 0;
      if (selectedSubject && attendanceLog[selectedSubject]) {
          Object.entries(attendanceLog[selectedSubject]).forEach(([dateStr, status]) => {
              const logDate = new Date(dateStr);
              if (logDate.getUTCFullYear() === currentDate.getFullYear() && logDate.getUTCMonth() === currentDate.getMonth()) {
                  if (status === 'present' || status === 'absent') conducted++;
                  if (status === 'present') attended++;
              }
          });
      }
      
      const currentPercentage = conducted > 0 ? (attended / conducted) * 100 : 0;
      
      let summaryMessage = '';
      if (!selectedSubject) {
        summaryMessage = `<p style="color: var(--slate-400);">Select a subject to see the summary.</p>`;
      } else if (conducted === 0) {
        summaryMessage = `<div style="color: var(--slate-400);"><p>No classes logged this month.</p><p style="font-size:0.75rem">Mark a day as present or absent!</p></div>`;
      } else if (currentPercentage >= TARGET_ATTENDANCE_PERCENTAGE) {
        const canAffordToMiss = Math.floor((attended - (TARGET_ATTENDANCE_PERCENTAGE / 100 * conducted)) / (TARGET_ATTENDANCE_PERCENTAGE / 100));
        summaryMessage = `<div style="color: var(--green-500);"><p style="font-weight:700;">You're on target! ðŸ”¥</p><p style="font-size:0.75rem;">You could have missed ${canAffordToMiss} more class${canAffordToMiss !== 1 ? 'es' : ''} and still been safe.</p></div>`;
      } else {
        const pTarget = TARGET_ATTENDANCE_PERCENTAGE / 100;
        const needToAttend = Math.ceil(((pTarget * conducted) - attended) / (1 - pTarget));
        summaryMessage = `<div style="color: var(--amber-400);"><p style="font-weight:700;">A little behind... ðŸ˜¬</p><p style="font-size:0.75rem;">You need to attend the next ${needToAttend} class${needToAttend !== 1 ? 'es' : ''} to get on track.</p></div>`;
      }
      
      DOM.summaryWrapper.innerHTML = `
        <h2 class="component-title text-gradient">3. Monthly Summary</h2>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
          <div class="summary-stats">
              <div>
                  <p class="stat-value" style="color: var(--cyan-400);">${conducted}</p>
                  <p class="stat-label">Conducted</p>
              </div>
              <div>
                  <p class="stat-value" style="color: var(--fuchsia-500);">${attended}</p>
                  <p class="stat-label">Attended</p>
              </div>
          </div>
          <div class="progress-bar-container">
              <div id="progress-bar" class="button-gradient" style="width: ${currentPercentage}%;"></div>
          </div>
          <p style="text-align:center; font-weight: 700; font-size: 1.25rem;">${currentPercentage.toFixed(1)}%</p>
          <div id="summary-message-box">${summaryMessage}</div>
          <div>
            <button id="excuse-button" class="button-gradient-alt" ${!selectedSubject ? 'disabled' : ''}>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1.25rem; height:1.25rem;">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.562L16.5 21.75l-.398-1.188a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.188-.398a2.25 2.25 0 001.423-1.423L16.5 15.75l.398 1.188a2.25 2.25 0 001.423 1.423l1.188.398-1.188.398a2.25 2.25 0 00-1.423 1.423z"/>
              </svg>
              <span id="excuse-button-text">Generate an Excuse</span>
            </button>
            <div id="excuse-result-container" class="hidden"></div>
          </div>
        </div>
      `;
      // Re-add event listener after re-render
      document.getElementById('excuse-button').addEventListener('click', handleGenerateExcuse);
    }

    // --- EVENT HANDLERS ---
    function handleLogin(e) {
      e.preventDefault();
      const username = DOM.usernameInput.value.trim();
      if (username) {
        APP_STATE.currentUser = username;
        saveToStorage(STORAGE_KEY_USER, username);
        init(); // Re-initialize the app state for the new user
      }
    }

    function handleLogout() {
      localStorage.removeItem(STORAGE_KEY_USER);
      APP_STATE.currentUser = null;
      APP_STATE.subjects = [];
      APP_STATE.attendanceLog = {};
      APP_STATE.selectedSubject = null;
      renderApp();
    }
    
    function handleAddSubject() {
        const subjectName = DOM.newSubjectInput.value.trim();
        if (subjectName && !APP_STATE.subjects.includes(subjectName)) {
            APP_STATE.subjects.push(subjectName);
            if(APP_STATE.subjects.length === 1) {
                APP_STATE.selectedSubject = subjectName;
            }
            DOM.newSubjectInput.value = '';
            saveToStorage(`funky-attendance-subjects-${APP_STATE.currentUser}`, APP_STATE.subjects);
            renderSubjectList();
            renderSummary();
            renderCalendar();
        }
    }
    
    function handleDeleteSubject(subjectName) {
        if (!confirm(`Are you sure you want to delete "${subjectName}" and its data?`)) return;

        APP_STATE.subjects = APP_STATE.subjects.filter(s => s !== subjectName);
        delete APP_STATE.attendanceLog[subjectName];
        
        if (APP_STATE.selectedSubject === subjectName) {
            APP_STATE.selectedSubject = APP_STATE.subjects[0] || null;
        }

        saveToStorage(`funky-attendance-subjects-${APP_STATE.currentUser}`, APP_STATE.subjects);
        saveToStorage(`funky-attendance-log-${APP_STATE.currentUser}`, APP_STATE.attendanceLog);
        
        renderSubjectList();
        renderSummary();
        renderCalendar();
    }

    function handleSelectSubject(subjectName) {
        APP_STATE.selectedSubject = subjectName;
        renderSubjectList();
        renderCalendar();
        renderSummary();
    }

    function handleDayClick(day) {
        const { selectedSubject, currentDate } = APP_STATE;
        if (!selectedSubject) return;

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const dateString = new Date(Date.UTC(year, month, day)).toISOString().split('T')[0];
        
        if (!APP_STATE.attendanceLog[selectedSubject]) {
            APP_STATE.attendanceLog[selectedSubject] = {};
        }

        const currentStatus = APP_STATE.attendanceLog[selectedSubject]?.[dateString];
        let nextStatus;
        if (!currentStatus) nextStatus = 'present';
        else if (currentStatus === 'present') nextStatus = 'absent';
        else if (currentStatus === 'absent') nextStatus = 'holiday';
        else nextStatus = null;
        
        if (nextStatus) {
            APP_STATE.attendanceLog[selectedSubject][dateString] = nextStatus;
        } else {
            delete APP_STATE.attendanceLog[selectedSubject][dateString];
        }

        saveToStorage(`funky-attendance-log-${APP_STATE.currentUser}`, APP_STATE.attendanceLog);
        renderCalendar();
        renderSummary();
    }
    
    async function handleGenerateExcuse() {
        const { selectedSubject } = APP_STATE;
        if (!selectedSubject) return;
        
        const excuseBtn = document.getElementById('excuse-button');
        const excuseBtnText = document.getElementById('excuse-button-text');
        const excuseContainer = document.getElementById('excuse-result-container');

        excuseBtn.disabled = true;
        excuseBtnText.textContent = 'Thinking...';
        excuseContainer.innerHTML = `<p style="text-align:center; font-size: 0.75rem; margin-top: 0.5rem; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;">AI is brewing a masterpiece...</p>`;
        excuseContainer.classList.remove('hidden');

        const excuse = await generateExcuse(selectedSubject);
        
        excuseContainer.innerHTML = `<div id="excuse-result" style="animation: scaleIn 0.3s ease;">"${excuse}"</div>`;
        excuseBtnText.textContent = 'Generate an Excuse';
        excuseBtn.disabled = false;
    }

    // --- EVENT LISTENER SETUP ---
    function addLoginEventListeners() {
      DOM.loginForm.addEventListener('submit', handleLogin);
      DOM.usernameInput.addEventListener('input', () => {
        DOM.loginButton.disabled = !DOM.usernameInput.value.trim();
      });
    }

    function addTrackerEventListeners() {
      DOM.logoutButton.addEventListener('click', handleLogout);
      DOM.addSubjectButton.addEventListener('click', handleAddSubject);
      DOM.newSubjectInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleAddSubject();
      });
      DOM.prevMonthButton.addEventListener('click', () => {
        APP_STATE.currentDate.setMonth(APP_STATE.currentDate.getMonth() - 1);
        renderCalendar(-1);
        renderSummary();
      });
      DOM.nextMonthButton.addEventListener('click', () => {
        APP_STATE.currentDate.setMonth(APP_STATE.currentDate.getMonth() + 1);
        renderCalendar(1);
        renderSummary();
      });
    }

    // --- INITIALIZATION ---
    function init() {
      APP_STATE.currentUser = loadFromStorage(STORAGE_KEY_USER, null);
      if (APP_STATE.currentUser) {
        APP_STATE.subjects = loadFromStorage(`funky-attendance-subjects-${APP_STATE.currentUser}`, []);
        APP_STATE.attendanceLog = loadFromStorage(`funky-attendance-log-${APP_STATE.currentUser}`, {});
        APP_STATE.selectedSubject = APP_STATE.subjects[0] || null;
        APP_STATE.currentDate = new Date();
      }
      renderApp();
    }

    // Start the application
    init();

  </script>
</body>
</html>
